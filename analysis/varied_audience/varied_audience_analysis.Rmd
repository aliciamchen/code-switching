---
title: "varied audience data analysis"
author: "Alicia Chen"
date: "2025-01-11"
output:
  html_document: default
---

```{r setup, include=FALSE}
library(here)
library(tidyverse)
library(tidyboot)
library(glue)
library(lme4)
library(lmerTest)
library(emmeans)
library(simr)

theme_set(theme_classic(base_size = 20))
options(contrasts = c(unordered = "contr.sum", ordered = "contr.poly"))
```

# Data, participants, and sanity checks

Load data

```{r}
selection_trials <- read_csv(here("data/varied_audience/selection_trials.csv")) %>%
  group_by(subject_id) %>%
  mutate(trial_num = row_number(), 
         n_total = n_ingroup + n_outgroup, 
         prop_outgroup = n_outgroup / n_total) %>%
  select(subject_id, item_id, trial_num, everything()) %>%
  ungroup()

selection_trials$tangram <- selection_trials$option1.tangram

exit_survey <-read_csv(here("data/varied_audience/exit_survey.csv"))
```

How many participants?

```{r}
n_participants <- n_distinct(selection_trials$subject_id)

n_understood <- exit_survey %>%
  filter(understood == "yes") %>%
  nrow()

print(glue("we have {n_participants} total participants, of which {n_understood} said they understood the instructions"))

# Exclude the participants who did not understand the instructions
selection_trials <- selection_trials %>%
  filter(understood == "yes")
```


Demographics

```{r}
exit_survey %>%
  group_by(gender) %>%
  count()

exit_survey %>%
  summarize(mean_age = mean(age), sd_age = sd(age), min_age = min(age),
    max_age = max(age))
```

## Counterbalancing assignments

How many participants were in each item_id, counterbalancing assignment?

```{r}
selection_trials %>%
  group_by(item_id, counterbalance) %>%
  summarize(n = n_distinct(subject_id))
```

## How many trials per condition?


```{r}
selection_trials %>%
  filter(type == "main") %>%
  group_by(n_ingroup, n_outgroup, goal) %>%
  count()
```

```{r}
selection_trials %>%
  filter(type == "main") %>%
  group_by(subject_id, n_ingroup, n_outgroup) %>%
  count()
```


Clean selection trials and output for model fitting

```{r}
selection_trials_clean <- selection_trials %>%
  filter(type == "main") %>%
  select(subject_id, item_id, counterbalance, n_ingroup, n_outgroup, goal, tangram, response.earlier) 

write_csv(selection_trials_clean, here("data/varied_audience/selection_trials_clean.csv"))
```

# Main trials


Calculate means

```{r}
main.trials <- selection_trials %>%
  filter(type == "main") %>%
  mutate(response.earlier = ifelse(response.earlier == "earlier", 1, 0))

main.trials.means <- main.trials %>%
  group_by(n_ingroup, n_outgroup, goal) %>%
  tidyboot_mean(response.earlier, na.rm = T)

main.trials.means.subj <-
  main.trials %>%
  group_by(subject_id, n_ingroup, n_outgroup, goal) %>%
  tidyboot_mean(response.earlier, na.rm = T)
```

Plot

```{r fig.width=16, fig.height=4}
ggplot(main.trials.means, aes(x = n_outgroup, y = empirical_stat, color = goal)) +
  geom_point(size = 3, fill = "black") +
  geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper), size = 1.5, width = 0.8) +
  geom_line(size = 1.2) +
  geom_hline(yintercept = 0.5, color = "red", linetype = "dashed") +
  labs(x = "n outgroup", y = "earlier or later label", title = "main trials") +
  scale_y_continuous(limits = c(-0.05, 1.05), breaks = c(0, 1), labels = c("later", "earlier")) +
  scale_color_discrete(name = "goal") +
  facet_wrap(~n_ingroup, labeller = label_both, nrow = 1)
```

```{r fig.width=16, fig.height=4}
ggplot(main.trials.means, aes(x = ifelse(n_outgroup == 0, -0.5, log(n_outgroup)), y = empirical_stat, color = goal)) +
  geom_point(size = 3, fill = "black") +
  geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper), size = 1.5, width = 0.2) +
  geom_line(size = 1.2) +
  geom_hline(yintercept = 0.5, color = "red", linetype = "dashed") +
  labs(x = "log n outgroup", y = "earlier or later label", title = "main trials") +
  scale_y_continuous(limits = c(-0.05, 1.05), breaks = c(0, 1), labels = c("later", "earlier")) +
  scale_x_continuous(limits = c(-0.7, max(log(main.trials$n_outgroup) + 0.1))) +
  scale_color_discrete(name = "goal") +
  facet_wrap(~n_ingroup, labeller = label_both, nrow = 1)
```

Plot proportion ingroup

```{r}
means.prop_outgroup <- main.trials %>%
  group_by(prop_outgroup,goal) %>% 
  tidyboot_mean(response.earlier, na.rm = T)
```


```{r}
ggplot(means.prop_outgroup, aes(x = prop_outgroup, y = empirical_stat, color = goal)) +
  geom_point(size = 3, fill = "black") +
  geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper), size = 1.5, width = 0.03) +
  geom_line(size = 1.2) +
  geom_hline(yintercept = 0.5, color = "red", linetype = "dashed") +
  labs(x = "proportion outgroup", y = "earlier or later label", title = "main trials") +
  scale_y_continuous(limits=c(-0.1, 1.1), breaks = c(0, 1), labels = c("later", "earlier")) +
  scale_color_discrete(name = "goal")
```


TODO: Correlate per-tangram effects with measured transparency differences between the tangrams

```{r}
transparency.data <- read_csv(here("data/transparency/means_by_label.csv"))
```
```{r}
main_trials <- main.trials %>%
  left_join(transparency.data, by = c("option1.tangram" = "target", "item_id" = "tangram_set", "option1.earlier" = "earlier", "option1.length" = "length", "option1.label" = "label")) %>% 
  select(-c(n, ci_lower, mean, ci_upper)) %>% 
  rename(earlier.transparency = empirical_stat) %>% 
  left_join(transparency.data, by = c("option2.tangram" = "target", "item_id" = "tangram_set", "option2.earlier" = "earlier", "option2.length" = "length", "option2.label" = "label")) %>%
  select(-c(n, ci_lower, mean, ci_upper)) %>%
  rename(later.transparency = empirical_stat) %>% 
  mutate(transparency_diff = earlier.transparency - later.transparency) %>% # add length
  mutate(length.diff = option1.length - option2.length)
```

```{r}
means.by.item <- main_trials %>%
  group_by(goal, option1.label, option2.label, earlier.transparency, later.transparency, transparency_diff, option1.length, option2.length, length.diff) %>%
  tidyboot_mean(response.earlier, na.rm = T)
```

```{r}
ggplot(means.by.item, aes(x = transparency_diff, y = empirical_stat, color = goal)) +
  geom_point(size = 3, fill = "black") +
  geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper), size = 1.5, width = 0.03) +
  geom_smooth(method = "lm", se = T) +
  geom_vline(xintercept = 0, color = "black", linetype = "dashed") +
  geom_hline(yintercept = 0.5, color = "black", linetype = "dashed") +
  labs(x = "earlier minus later transparency", y = "P(earlier label)", title = "varied audience") + 
  scale_y_continuous(limits = c(-0.1, 1.1), breaks = c(0, 0.5, 1)) 
```

What about just later transparency value 

```{r}
ggplot(means.by.item, aes(x = later.transparency, y = empirical_stat, color = goal)) +
  geom_point(size = 3, fill = "black") +
  geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper), size = 1.5, width = 0.03) +
  geom_smooth(method = "lm", se = T) +
  geom_hline(yintercept = 0.5, color = "black", linetype = "dashed") +
  labs(x = "later label transparency", y = "P(earlier label)", title = "varied audience") + 
  scale_y_continuous(limits = c(-0.1, 1.1), breaks = c(0, 0.5, 1)) +
  scale_x_continuous(limits = c(-0.1, 1.1), breaks = c(0, 0.5, 1)) + 
  scale_color_manual(values = c("refer" = "#018794", "social" = "#DE8F05"))
```

what about cost diff? 


```{r}
ggplot(means.by.item, aes(x = length.diff, y = empirical_stat, color = goal)) +
  geom_point(size = 3, fill = "black") +
  geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper), size = 1.5, width = 0.03) +
  geom_smooth(method = "lm", se = T) +
  geom_hline(yintercept = 0.5, color = "black", linetype = "dashed") +
  labs(x = "earlier length minus later length", y = "P(earlier label)", title = "varied audience") + 
  scale_y_continuous(limits = c(-0.1, 1.1), breaks = c(0, 0.5, 1))
```

```{r}
mod.item <- lm(empirical_stat ~ transparency_diff + length.diff, data = means.by.item %>% filter(goal == 'refer'))
summary(mod.item)
```


## Filter participants for above-chance performance on the baselines

And repeat above analyses

```{r}
baseline.trials <- selection_trials %>%
  filter(type == "baseline")

above_chance_ppl <- baseline.trials %>%
  group_by(subject_id) %>%
  summarize(above_chance = sum(response.group == "unseen") < 3) %>%
  filter(above_chance) %>%
  select(subject_id)

selection_trials_filtered <- selection_trials %>%
  filter(subject_id %in% above_chance_ppl$subject_id)
```

how many participants are left? 

```{r}
n_participants <- n_distinct(selection_trials_filtered$subject_id)
n_participants
```

```{r}
main.trials_filtered <- selection_trials_filtered %>%
  filter(type == "main") %>%
  mutate(response.earlier = ifelse(response.earlier == "earlier", 1, 0))

main.trials.means_filtered <- main.trials_filtered %>%
  group_by(n_ingroup, n_outgroup, goal) %>%
  tidyboot_mean(response.earlier, na.rm = T)

main.trials.means.subj_filtered <-
  main.trials_filtered %>%
  group_by(subject_id, n_ingroup, n_outgroup, goal) %>%
  tidyboot_mean(response.earlier, na.rm = T)
```

Plot

```{r fig.width=16, fig.height=4}
ggplot(main.trials.means_filtered, aes(x = n_outgroup, y = empirical_stat, color = goal)) +
  geom_point(size = 3, fill = "black") +
  geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper), size = 1.5, width = 0.8) +
  geom_line(size = 1.2) +
  geom_hline(yintercept = 0.5, color = "red", linetype = "dashed") +
  labs(x = "n outgroup", y = "earlier or later label", title = "main trials") +
  scale_y_continuous(limits = c(-0.05, 1.05), breaks = c(0, 1), labels = c("later", "earlier")) +
  scale_color_discrete(name = "goal") +
  facet_wrap(~n_ingroup, labeller = label_both, nrow = 1)
```

```{r fig.width=16, fig.height=4}
ggplot(main.trials.means_filtered, aes(x = ifelse(n_outgroup == 0, -0.5, log(n_outgroup)), y = empirical_stat, color = goal)) +
  geom_point(size = 3, fill = "black") +
  geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper), size = 1.5, width = 0.2) +
  geom_line(size = 1.2) +
  geom_hline(yintercept = 0.5, color = "red", linetype = "dashed") +
  labs(x = "log n outgroup", y = "earlier or later label", title = "main trials") +
  scale_y_continuous(limits = c(-0.05, 1.05), breaks = c(0, 1), labels = c("later", "earlier")) +
  scale_x_continuous(limits = c(-0.7, max(log(main.trials$n_outgroup) + 0.1))) +
  scale_color_discrete(name = "goal") +
  facet_wrap(~n_ingroup, labeller = label_both, nrow = 1)
```

Plot proportion ingroup

```{r}
means.prop_outgroup_filtered <- main.trials_filtered %>%
  group_by(prop_outgroup,goal) %>% 
  tidyboot_mean(response.earlier, na.rm = T)
```

```{r}
ggplot(means.prop_outgroup_filtered, aes(x = prop_outgroup, y = empirical_stat, color = goal)) +
  geom_point(size = 3, fill = "black") +
  geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper), size = 1.5, width = 0.03) +
  geom_line(size = 1.2) +
  geom_hline(yintercept = 0.5, color = "red", linetype = "dashed") +
  labs(x = "proportion outgroup", y = "earlier or later label", title = "main trials") +
  scale_y_continuous(limits=c(-0.1, 1.1), breaks = c(0, 1), labels = c("later", "earlier")) +
  scale_color_discrete(name = "goal")
```


# Analyze performance on the baseline trials

```{r}
baseline.trials <- baseline.trials %>%
  mutate(response.seen = ifelse(response.group == "unseen", 0, 1))
```

```{r}
baseline.trials.means <- baseline.trials %>%
  tidyboot_mean(response.seen, na.rm = T)

baseline.trials.means
```

Preregistered linear model

```{r}
mod.baseline <- glmer(response.seen ~ 1 + (1 | subject_id) + (1 | item_id / tangram), data = baseline.trials, family = "binomial", control = glmerControl(optimizer = "bobyqa"))
summary(mod.baseline)
```


```{r}
# Inverse logit function
inv_logit <- function(x) {
  exp(x) / (1 + exp(x))
}

inv_logit(fixef(mod.baseline))
```


# Data analysis

## main preregistered model

```{r}
mod.without.transparency <- glmer(response.earlier ~ prop_outgroup * goal + n_total +  (1 | subject_id) + (1 | item_id/ tangram), data = main_trials, family = "binomial", control = glmerControl(optimizer = "bobyqa"))
summary(mod.without.transparency)
```

```{r}
mod.with.transparency <- glmer(response.earlier ~ prop_outgroup * goal + n_total + transparency_diff + (1 | subject_id) + (1 | item_id/ tangram), data = main_trials, family = "binomial", control = glmerControl(optimizer = "bobyqa"))
summary(mod.with.transparency)
```

```{r}
anova(mod.without.transparency, mod.with.transparency, test = "LRT")
```

It looks like adding the transparency predictor makes the model do better. 

What about a polynomial term? 

```{r}
mod.with.transparency.poly <- glmer(
  response.earlier ~ poly(prop_outgroup, 2) * goal + transparency_diff + (prop_outgroup + goal |
                                                                                      subject_id) + (prop_outgroup + goal |
                                                                                                       item_id/tangram),
  data = main_trials,
  family = "binomial",
  control = glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 500000))
)
summary(mod.with.transparency.poly)
```
```{r}
emtrends(mod.with.transparency.poly, ~ goal, var = "prop_outgroup", type = "response", max.degree = 2) %>%
  summary(infer = T)
```

```{r}
anova(mod.with.transparency, mod.with.transparency.poly, test = "LRT")
```

## Comparisons between means

Differences between goals, across all other conditions

```{r}
emmeans(mod.with.transparency.poly, pairwise ~ goal) %>%
  summary(infer = T)
```
differences between goals, for each level of prop_outgroup

```{r}
emmeans(mod.with.transparency.poly, pairwise ~ goal | prop_outgroup, 
        at = list(prop_outgroup = unique(main_trials$prop_outgroup))) %>%
  summary(infer = TRUE)
```

Let's just compare the 'refer' and 'social' conditions for the 0% naive condition (do we replicate the effect in the other experiment?)

```{r}
mod_0_naive <- glmer(
  response.earlier ~ goal + (1 + goal | subject_id) + (1 + goal| item_id/ tangram),
  data = main_trials %>% filter(prop_outgroup == 0),
  family = "binomial",
  control = glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 50000))
)
summary(mod_0_naive)
```

Comparison between refer and social

```{r}
emmeans(mod_0_naive, pairwise ~ goal) %>%
  summary(infer = T)
```

It looks like there is an effect but it is very small

# Exit survey

What feedback did participants give?

```{r}
exit_filtered <- exit_survey %>%
  filter(!is.na(comments))
exit_filtered$comments
```
