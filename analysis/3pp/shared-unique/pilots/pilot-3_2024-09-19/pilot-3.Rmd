---
title: "pilot 3"
author: "Alicia Chen"
date: "2024-09-19"
output:
  html_document: default
---

```{r setup, include=FALSE}
library(here)
library(tidyverse)
library(tidyboot)
library(lme4)
library(lmerTest)
library(emmeans)
library(simr)

theme_set(theme_classic(base_size = 20))
options(contrasts = c(unordered = "contr.sum", ordered = "contr.poly"))
```

# Selection trials

```{r}
selection_trials <- read_csv(here("data", "pilot-3_2024-09-19", "selection_trials.csv")) %>% 
  group_by(subject_id) %>%
  mutate(trial_num = row_number()) %>% 
  select(subject_id, item_id, trial_num, everything()) %>% 
  ungroup()
```
Main trials (different tangrams shown): Are there differences between refer and social goals?

Prediction: For "refer" to either group, people should choose the shared tangram. For "refer" to one group, people should equally choose between the two tangrams. For the "social" goal, people should choose the unique tangram. 

```{r}
selection_trials_means <- selection_trials %>%
  filter(type == "diff") %>% 
  mutate(response.shared = if_else(response.shared == "shared", 1, 0)) %>%
  group_by(goal, audience) %>%
  tidyboot_mean(response.shared, na.rm = T)

selection_trials_means
```

Plot means aggregated across participants

```{r}
filtered_trials <- selection_trials %>%
  mutate(response.shared = if_else(response.shared == "shared", 1, 0)) %>%
  filter(type == "diff")

filtered_means <- selection_trials_means
```

```{r}
ggplot(filtered_trials,
       aes(x = goal, y = response.shared, color = audience)) +
  geom_point(
    position = position_jitterdodge(
      jitter.width = 0.15,
      jitter.height = 0.1,
      dodge.width = 0.3
    ),
    size = 3,
    stroke = 0,
    alpha = 0.3
  ) +
  geom_point(
    data = filtered_means,
    position = position_dodge(width = 0.3),
    aes(x = goal, y = empirical_stat, color = audience),
    size = 3,
    fill = "black",
    inherit.aes = FALSE
  ) +
  geom_errorbar(
    data = filtered_means,
    position = position_dodge(width = 0.3),
    aes(
      x = goal,
      ymin = ci_lower,
      ymax = ci_upper,
      color = audience
    ),
    size = 1.5,
    width = 0.05,
    inherit.aes = FALSE
  ) +
  geom_hline(yintercept = 0.5,
             color = "red",
             linetype = "dashed") +
  labs(x = "goal", y = "shared or unique label", title = "different tangrams") +
  scale_y_continuous(breaks = c(0, 1),
                     labels = c("unique", "shared")) 
```


## Plot slopes per participant

```{r}
selection_trials_means_participant <- selection_trials %>%
  filter(type == "diff") %>%
  mutate(response.shared = if_else(response.shared == "shared", 1, 0)) %>%
  group_by(subject_id, audience, goal) %>%
  tidyboot_mean(response.shared, na.rm = T)
```


```{r}
inner_dodge <- position_dodge(width = 0.79)

selection_trials_means_participant$audience_goal <- with(selection_trials_means_participant,
                                                         interaction(audience, goal, sep = " "))

ggplot(
  selection_trials_means_participant,
  aes(
    x = audience_goal,
    y = empirical_stat,
    group = subject_id,
    color = audience
  )
) +
  geom_line(position = position_dodge(width = 0.2),
            aes(group = subject_id),
            alpha = 0.5) +
  geom_point(
    position = position_dodge(width = 0.2),
    size = 2,
    fill = "black",
    alpha = 0.7
  ) +
  geom_errorbar(
    position = position_dodge(width = 0.2),
    aes(ymin = ci_lower, ymax = ci_upper),
    size = 1.4,
    width = 0.2,
    alpha = 0.7
  ) +
  geom_hline(yintercept = 0.5,
             color = "red",
             linetype = "dashed") +
  labs(x = "audience + goal", y = "shared or unique", title = "different tangrams") +
  scale_y_continuous(breaks = c(0, 1),
                     labels = c("unique", "shared"))

```


## Control trials: choosing between the same tangram

For the "refer" goal, people should choose the seen label over the unseen label, both when talking to one group and when talking to either group

```{r}
control_trials_refer <- selection_trials %>% 
  filter(type == "same", goal == "refer") %>% 
  mutate(seen = case_when(
    response.group == "unseen" ~ 0,
    response.shared == "shared" ~ 1
  ))
 
  
control_trials_refer.means <- control_trials_refer %>% 
  group_by(audience) %>% 
  tidyboot_mean(seen, na.rm = T)
```

```{r fig.width=3, fig.height=4}
ggplot(control_trials_refer, aes(x = audience, y = seen)) +
  geom_jitter(size = 3, stroke = 0, width = 0.15, height = 0.1, alpha = 0.3) +
  geom_point(data = control_trials_refer.means, aes(x = audience, y = empirical_stat), size = 3, fill = "black", inherit.aes = FALSE) +
  geom_errorbar(data = control_trials_refer.means, aes(x = audience, ymin = ci_lower, ymax = ci_upper), size = 1.5, width = 0.05, inherit.aes = FALSE) +
  geom_hline(yintercept = 0.5, color = "red", linetype = "dashed") +
  labs(x = "audience", y = "seen or unseen label", title = "same tangrams") +
  scale_y_continuous(breaks = c(0, 1), labels = c("unseen", "seen")) +
  theme(legend.position = "none", plot.title = element_text(size = 15))
```

For the "social" goal, people should choose the tangram belonging to the audience group

```{r}
control_trials_social <- selection_trials %>% 
  filter(type == "same", goal == "social") %>% 
  mutate(group_label = ifelse(audience_group == response.group, 1, 0))

control_trials_social.means <- control_trials_social %>%
  tidyboot_mean(group_label, na.rm = T) %>% 
  mutate(goal = "social")
```

```{r fig.width=3, fig.height=4}
ggplot(control_trials_social, aes(x = goal, y = group_label)) +
  geom_jitter(size = 3, stroke = 0, width = 0.15, height = 0.1, alpha = 0.3) +
  geom_point(data = control_trials_social.means, aes(x = goal, y = empirical_stat), size = 3, fill = "black", inherit.aes = FALSE) +
  geom_errorbar(data = control_trials_social.means, aes(x = goal, ymin = ci_lower, ymax = ci_upper), size = 1.5, width = 0.05, inherit.aes = FALSE) +
  geom_hline(yintercept = 0.5, color = "red", linetype = "dashed") +
  labs(x = "goal", y = "label belongs to audience grp", title = "same tangrams") +
  scale_y_continuous(breaks = c(0, 1), labels = c("no", "yes")) +
  theme(legend.position = "none", plot.title = element_text(size = 15))
```

### Correlate results for same and different tangram trials

across participants, does % selecting shared, for different tangrams, correlate with % selecting Seen in same tangram, in the "both refer" condition?


```{r}
pct.seen.both.refer <- control_trials_refer %>% 
  filter(audience == "both") %>% 
  group_by(subject_id) %>% 
  tidyboot_mean(seen, na.rm = T) 

pct.shared.diff <- selection_trials_means_participant %>%
  filter(goal == "refer", audience == "both")
```

```{r}
# plot
ggplot(pct.seen.both.refer, aes(x = empirical_stat, y = pct.shared.diff$empirical_stat)) +
  geom_point(alpha = 0.5, size = 3) +
  # add error bars in both directions
  lims(x = c(0, 1), y = c(0, 1)) +
  labs(x = "prop Seen, same tangram", y = "prop Shared, diff tangrams", title = "refer to both groups")
```


Across participants, does % selecting unique, for different tangrams, correlate with %  Correct in same tangram, in the "social" condition?

```{r}
pct.correct.social <- control_trials_social %>% 
  filter(goal == "social") %>% 
  group_by(subject_id) %>% 
  tidyboot_mean(group_label, na.rm = T)

pct.unique.diff <- selection_trials_means_participant %>%
  filter(goal == "social")
```

```{r}
ggplot(pct.correct.social, aes(x = empirical_stat, y = pct.unique.diff$empirical_stat)) +
  geom_point(alpha = 0.5, size = 3) +
  lims(x = c(0, 1), y = c(0, 1)) +
  labs(x = "prop Correct group, same tangram", y = "prop Unique, diff tangrams", title = "social goal")
```




### What does it look like for the first half of trials? 


Do participants do worse in the same-tangram trials, for the first half of trials? 

```{r}
control_trials_refer_first_half <- selection_trials %>% 
  filter(type == "same", goal == "refer", trial_num < 40) %>% 
  mutate(seen = case_when(
    response.group == "unseen" ~ 0,
    response.shared == "shared" ~ 1
  ))
 
control_trials_refer.means_first_half <- control_trials_refer_first_half %>% 
  group_by(audience) %>% 
  tidyboot_mean(seen, na.rm = T)
```

```{r fig.width=3, fig.height=4}
ggplot(control_trials_refer_first_half, aes(x = audience, y = seen)) +
  geom_jitter(size = 3, stroke = 0, width = 0.15, height = 0.1, alpha = 0.3) +
  geom_point(data = control_trials_refer.means_first_half, aes(x = audience, y = empirical_stat), size = 3, fill = "black", inherit.aes = FALSE) +
  geom_errorbar(data = control_trials_refer.means_first_half, aes(x = audience, ymin = ci_lower, ymax = ci_upper), size = 1.5, width = 0.05, inherit.aes = FALSE) +
  geom_hline(yintercept = 0.5, color = "red", linetype = "dashed") +
  labs(x = "audience", y = "seen or unseen label", title = "same tangrams") +
  scale_y_continuous(breaks = c(0, 1), labels = c("unseen", "seen")) +
  theme(legend.position = "none", plot.title = element_text(size = 15))
```

```{r}
control_trials_social_first_half <- selection_trials %>% 
  filter(type == "same", goal == "social", trial_num < 40) %>% 
  mutate(group_label = ifelse(audience_group == response.group, 1, 0))

control_trials_social.means_first_half <- control_trials_social %>%
  tidyboot_mean(group_label, na.rm = T) %>% 
  mutate(goal = "social")
```

```{r fig.width=3, fig.height=4}
ggplot(control_trials_social_first_half, aes(x = goal, y = group_label)) +
  geom_jitter(size = 3, stroke = 0, width = 0.15, height = 0.1, alpha = 0.3) +
  geom_point(data = control_trials_social.means_first_half, aes(x = goal, y = empirical_stat), size = 3, fill = "black", inherit.aes = FALSE) +
  geom_errorbar(data = control_trials_social.means_first_half, aes(x = goal, ymin = ci_lower, ymax = ci_upper), size = 1.5, width = 0.05, inherit.aes = FALSE) +
  geom_hline(yintercept = 0.5, color = "red", linetype = "dashed") +
  labs(x = "goal", y = "label belongs to audience grp", title = "same tangrams") +
  scale_y_continuous(breaks = c(0, 1), labels = c("no", "yes")) +
  theme(legend.position = "none", plot.title = element_text(size = 15))
```


## Memory for specific tangrams

```{r}
control_trials_refer.memory <- control_trials_refer %>% 
  group_by(option1.tangram, option1.label) %>% 
  tidyboot_mean(seen, na.rm = T)
```

```{r}
control_trials_social.memory <- control_trials_social %>% 
  group_by(option1.tangram, option1.label, option2.tangram, option2.label) %>% 
  tidyboot_mean(group_label, na.rm = T)
```


# Power analysis on pilot data

```{r}
diff_tangrams <- selection_trials %>% mutate(
  response.unique = ifelse(response.shared == "shared", 0, 1)
) %>% 
  filter(type == "diff")
```

```{r}
mod <- glmer(response.unique ~ audience * goal + (1 | subject_id) + (1 | item_id/ option2.tangram), data = diff_tangrams, family = "binomial")
```

```{r}
summary(mod)
```

Comparisons between means

```{r}
emmeans(mod, pairwise ~ goal|audience) %>% 
  summary(infer = T)
```

```{r}
sum <- summary(contrast(emmeans(mod, ~ goal | audience), method = "pairwise"))$p.value
sum
```


```{r}
# extract the one refer - one social contrast
test_one_refer_vs_one_social <- function(mod) {
  emm <- emmeans(mod, ~ goal | audience)
  contrast_results <- contrast(emm, method = "pairwise")
  
  # Extract p-value for the "one refer vs. one social" contrast
  # Assuming it is the first contrast in the results
  pval <- summary(contrast_results)$p.value[2]
  
  return(pval)
}
```

```{r}
power_result <- powerSim(mod, test = test_one_refer_vs_one_social, nsim = 100)
print(power_result)
```

```{r}
extended_model <- extend(mod, along = "subject_id", n = 30)
```

```{r}
power_result <- powerSim(extended_model, test = test_one_refer_vs_one_social, nsim = 100)
print(power_result)
```


```{r}
# Plot the extended power curve
power_curve_extended <- powerCurve(extended_model, test = test_one_refer_vs_one_social, along = "subject_id", nsim = 50)
plot(power_curve_extended)
```

```{r}
power_result <- powerSim(extended_model, test = test_one_refer_vs_one_social, nsim = 50)
print(power_result)
```




# Exit survey

```{r}
exit_survey <- read_csv(here("data", "pilot-3_2024-09-19", "exit_survey.csv"))
```

What feedback did participants give?

```{r}
exit_survey$feedback
```

